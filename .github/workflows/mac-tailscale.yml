name: Setup Remote Access on macOS Runner (Using Bore)

on:
  workflow_dispatch:
    inputs:
      vnc_password:
        description: 'VNC Password for Screen Sharing'
        required: true
        type: string
      # ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© tailscale_auth_key Ù„Ø£Ù†Ù‡ Ù„Ù… ÙŠØ¹Ø¯ Ù…Ø·Ù„ÙˆØ¨Ù‹Ø§

jobs:
  setup-access:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # Step 1: Install Bore Tunneling Tool
      # -----------------------------------------------------
      - name: Install Bore via Homebrew
        run: |
          # Bore Ù‡Ùˆ Ø§Ù„Ø£ÙØ¶Ù„ ØªØ«Ø¨ÙŠØªÙ‡ Ø¹Ø¨Ø± Homebrew Ø¹Ù„Ù‰ macOS
          brew install bore-cli
          echo "âœ… Bore has been installed."

      # -----------------------------------------------------
      # Step 2: Enable Screen Sharing (VNC Server) via CLI
      # -----------------------------------------------------
      - name: Configure and Activate VNC (Screen Sharing)
        run: |
          echo "Activating Screen Sharing service..."
          # -----------------------------------------------------
      # NEW STEP: Fix Black Screen Issue for Headless Runner
      # -----------------------------------------------------
      - name: Fix Black Screen by Creating Virtual Display Session
        run: |
          echo "Attempting to create a virtual display session..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/CGDisplayChangeShowHeadlessUI 1
          osascript -e 'tell application "Finder" to set visible of process "Finder" to true'
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -allowAccessFor -allUsers -privs -all -restart -console
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -deactivate -stop
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -restart -agent
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw "${{ inputs.vnc_password }}" -restart -console

      # -----------------------------------------------------
      # Step 3: Start Bore Tunnel and Display Connection Info
      # -----------------------------------------------------
      - name: Start Bore Tunnel for VNC (Port 5900)
        run: |
          echo "Starting Bore tunnel for VNC (port 5900)..."
          bore local 5900 --to bore.pub
          
          echo "âœ… VNC should now be active."
          echo "ğŸŒ The Bore tunnel is open to bore.pub on port: $PUBLIC_PORT"
          echo "ğŸ”‘ To connect, use VNC client to access: bore.pub:$PUBLIC_PORT"