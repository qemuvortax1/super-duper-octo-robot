name: Setup Remote Access on macOS Runner

on:
  workflow_dispatch:
    inputs:
      tailscale_auth_key:
        description: 'Tailscale Auth Key (Optional if already logged in)'
        required: false
        type: string
      vnc_password:
        description: 'VNC Password for Screen Sharing'
        required: true
        type: string

jobs:
  setup-access:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # Step 1: Install and Configure Tailscale VPN
      # -----------------------------------------------------
      - name: Install Tailscale on macOS
        run: |
          # Download and install the Tailscale app via Homebrew
          brew install --cask tailscale
          # ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø®Ø§Ø·Ø¦ Ù„Ù€ launchctl load. Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨ÙˆØ§Ø³Ø·Ø© tailscale up.

      - name: Log in to Tailscale using Auth Key
        # This step uses the provided input key for authentication
        if: ${{ inputs.tailscale_auth_key != '' }}
        run: |
          # Start the Tailscale service and log the machine into your network
          sudo tailscale up --authkey ${{ inputs.tailscale_auth_key }} --accept-routes

      # -----------------------------------------------------
      # Step 2: Enable Screen Sharing (VNC Server) via CLI
      # -----------------------------------------------------
      - name: Configure and Activate VNC (Screen Sharing)
        run: |
          echo "Activating Screen Sharing service..."
          # 1. Activate Remote Management, allow all users, and grant full privileges
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -allowAccessFor -allUsers -privs -all -restart -console
          
          # 2. Corrected command: Configure VNC password and enable legacy VNC access
          # ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¯Ø®Ù„ vnc_password Ù„ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw "${{ inputs.vnc_password }}" -restart -console

      # -----------------------------------------------------
      # Step 3: Display Connection Info (Optional)
      # -----------------------------------------------------
      - name: Get Tailscale IP address and Hostname
        run: |
          IP_ADDR=$(tailscale ip -4)
          HOSTNAME=$(hostname)
          echo "âœ… VNC should now be active."
          echo "ğŸŒ You can connect using your Tailscale IP: $IP_ADDR"
          echo "ğŸ’» Or by hostname: $HOSTNAME.ts.net"
