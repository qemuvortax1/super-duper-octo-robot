name: Setup Remote Access on macOS Runner (Using Bore)

on:
  workflow_dispatch:
    inputs:
      vnc_password:
        description: 'VNC Password for Screen Sharing'
        required: true
        type: string
      # ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© tailscale_auth_key Ù„Ø£Ù†Ù‡ Ù„Ù… ÙŠØ¹Ø¯ Ù…Ø·Ù„ÙˆØ¨Ù‹Ø§

jobs:
  setup-access:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # Step 1: Install Bore Tunneling Tool
      # -----------------------------------------------------
      - name: Install Bore via Homebrew
        run: |
          # Bore Ù‡Ùˆ Ø§Ù„Ø£ÙØ¶Ù„ ØªØ«Ø¨ÙŠØªÙ‡ Ø¹Ø¨Ø± Homebrew Ø¹Ù„Ù‰ macOS
          brew install bore-cli
          echo "âœ… Bore has been installed."

      # -----------------------------------------------------
      # Step 2: Enable Screen Sharing (VNC Server) via CLI
      # -----------------------------------------------------
      - name: Configure and Activate VNC (Screen Sharing)
        run: |
          echo "Activating Screen Sharing service..."
          # 1. Activate Remote Management, allow all users, and grant full privileges
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -allowAccessFor -allUsers -privs -all -restart -console
          
          # 2. Corrected command: Configure VNC password and enable legacy VNC access
          # ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¯Ø®Ù„ vnc_password Ù„ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw "${{ inputs.vnc_password }}" -restart -console

      # -----------------------------------------------------
      # Step 3: Start Bore Tunnel and Display Connection Info
      # -----------------------------------------------------
      - name: Start Bore Tunnel for VNC (Port 5900)
        run: |
          echo "Starting Bore tunnel for VNC (port 5900)..."
          # ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Bore ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… &
          # Ø§Ù„Ù…Ù†ÙØ° Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù€ Screen Sharing (VNC) Ù‡Ùˆ 5900
          # ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø§Ø­Ø¸Ø©: Bore.pub Ù‡Ùˆ Ø®Ø§Ø¯Ù… ÙˆØ³ÙŠØ· Ø¹Ø§Ù….
          
          # ØªØ´ØºÙŠÙ„ Bore ÙˆØ§Ù„ØªÙ‚Ø§Ø· Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ÙØ° Ø§Ù„Ø¹Ø§Ù… ÙÙŠ Ù…ØªØºÙŠØ±
          BORE_OUTPUT=$(bore local 5900 --to bore.pub &)
          
          # Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†ÙÙ‚ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬
          sleep 5
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù†ÙØ° Ø§Ù„Ø¹Ø§Ù… Ù…Ù† Ø¥Ø®Ø±Ø§Ø¬ bore
          PUBLIC_PORT=$(echo "$BORE_OUTPUT" | grep 'Public address:' | awk -F ':' '{print $3}')
          
          echo "âœ… VNC should now be active."
          echo "ğŸŒ The Bore tunnel is open to bore.pub on port: $PUBLIC_PORT"
          echo "ğŸ”‘ To connect, use VNC client to access: bore.pub:$PUBLIC_PORT"
          
          # Ø¹Ø±Ø¶ Ø¥Ø®Ø±Ø§Ø¬ bore Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
          echo "--- Bore Output ---"
          echo "$BORE_OUTPUT"
          sleep 6796869
